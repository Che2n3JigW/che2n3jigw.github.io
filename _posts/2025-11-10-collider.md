---
categories: Android
tags: webrtc
title: Collider ä¿¡ä»¤æœåŠ¡å™¨
toc: true
toc_sticky: true
excerpt: Collider å°±æ˜¯ WebRTC çš„ä¿¡ä»¤æœåŠ¡å™¨ï¼Œè´Ÿè´£è½¬å‘ SDPã€ICE Candidate å’Œç®¡ç†æˆ¿é—´ç”¨æˆ·çŠ¶æ€ï¼Œä½†ä¸å¤„ç†å®é™…éŸ³è§†é¢‘æµã€‚
---

Collider å°±æ˜¯ WebRTC çš„ä¿¡ä»¤æœåŠ¡å™¨ï¼Œè´Ÿè´£è½¬å‘ SDPã€ICE Candidate å’Œç®¡ç†æˆ¿é—´ç”¨æˆ·çŠ¶æ€ï¼Œä½†ä¸å¤„ç†å®é™…éŸ³è§†é¢‘æµã€‚

---

ğŸ‘‰ **collider ä¸æ˜¯ç”Ÿäº§çº§æœåŠ¡å™¨ï¼Œä¸å®‰å…¨ã€ä¸ç¨³å®šã€ä¸é«˜å¹¶å‘ã€‚**

 ğŸ‘‰ Google å®˜æ–¹ä¹Ÿè¯´äº†ï¼š**ä»…ä¾› demoï¼Œä¸æ¨èç”¨äºæ­£å¼ç¯å¢ƒã€‚**

# collidermain

## main.go

``` go
// tlsï¼šå¸ƒå°”å€¼ï¼Œé»˜è®¤ trueï¼Œè¡¨ç¤ºæ˜¯å¦å¯ç”¨ TLSï¼ˆHTTPSï¼‰ã€‚
var tls = flag.Bool("tls", true, "whether TLS is used")

// portï¼šæ•´æ•°å€¼ï¼Œé»˜è®¤ 443ï¼Œè¡¨ç¤ºæœåŠ¡ç›‘å¬çš„ç«¯å£ã€‚
var port = flag.Int("port", 443, "The TCP port that the server listens on")

// room-serverï¼šå­—ç¬¦ä¸²ï¼Œé»˜è®¤ "https://appr.tc"ï¼Œè¡¨ç¤º æˆ¿é—´æœåŠ¡å™¨ çš„ URLã€‚
var roomSrv = flag.String("room-server", "https://appr.tc", "The origin of the room server")

// è§£æå‘½ä»¤è¡Œä¼ å…¥çš„å‚æ•°
flag.Parse()

// æ‰“å°
log.Printf("Starting collider: tls = %t, port = %d, room-server=%s", *tls, *port, *roomSrv)

// åˆ›å»ºä¸€ä¸ª Collider å®ä¾‹
c := collider.NewCollider(*roomSrv)

// å¯åŠ¨æœåŠ¡
c.Run(*port, *tls)
```



# collider

## collider.go

| æ–¹æ³•å                                                      | å‚æ•°                                | è¯´æ˜                                                         |
| ----------------------------------------------------------- | ----------------------------------- | ------------------------------------------------------------ |
| `NewCollider(rs string)`                                    | `rs`ï¼šæˆ¿é—´æœåŠ¡å™¨ URL                | åˆ›å»º `Collider` å®ä¾‹ï¼Œåˆå§‹åŒ– `roomTable` å’Œ `dashboard`ã€‚    |
| `Run(p int, useTls bool)`                                   | `p`ï¼šç«¯å£å·ï¼Œ`useTls`ï¼šæ˜¯å¦å¯ç”¨ TLS | å¯åŠ¨ HTTP/HTTPS + WebSocket æœåŠ¡ï¼Œé˜»å¡ä¸»çº¿ç¨‹ã€‚               |
| `httpStatusHandler(w http.ResponseWriter, r *http.Request)` | HTTP è¯·æ±‚/å“åº”å¯¹è±¡                  | HTTP GET `/status`ï¼Œè¿”å›æœåŠ¡çŠ¶æ€ JSONï¼ˆæˆ¿é—´æ•°ã€å®¢æˆ·ç«¯æ•°ç­‰ï¼‰ã€‚ |
| `httpHandler(w http.ResponseWriter, r *http.Request)`       | HTTP è¯·æ±‚/å“åº”å¯¹è±¡                  | HTTP POST/DELETE `/ROOMID/CLIENTID`ï¼Œç”¨äºå‘é€æ¶ˆæ¯æˆ–åˆ é™¤å®¢æˆ·ç«¯è®°å½•ã€‚ |
| `wsHandler(ws *websocket.Conn)`                             | WebSocket è¿æ¥å¯¹è±¡                  | WebSocket æ¶ˆæ¯å¤„ç†ï¼ŒåŒ…æ‹¬ï¼š`register` æ³¨å†Œå®¢æˆ·ç«¯ï¼Œ`send` å‘é€æ¶ˆæ¯ã€‚ |
| `httpError(msg string, w http.ResponseWriter)`              | é”™è¯¯æ¶ˆæ¯ï¼ŒHTTP å“åº”å¯¹è±¡             | å¤„ç† HTTP é”™è¯¯ï¼Œè¿”å› 500 å¹¶è®°å½•åˆ° dashboardã€‚                |
| `wsError(msg string, ws *websocket.Conn)`                   | é”™è¯¯æ¶ˆæ¯ï¼ŒWebSocket è¿æ¥å¯¹è±¡        | å¤„ç† WebSocket é”™è¯¯ï¼Œå‘é€é”™è¯¯æ¶ˆæ¯ç»™å®¢æˆ·ç«¯å¹¶è®°å½•åˆ° dashboardã€‚ |

## dashboard.go

| æ–¹æ³•å                                     | å‚æ•°            | è¿”å›å€¼         | ä½œç”¨è¯´æ˜                                                     |
| ------------------------------------------ | --------------- | -------------- | ------------------------------------------------------------ |
| `newDashboard()`                           | æ—               | `*dashboard`   | åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ `dashboard` å®ä¾‹ï¼Œè®°å½• `startTime`ã€‚    |
| `(db *dashboard) getReport(rs *roomTable)` | `rs *roomTable` | `statusReport` | è·å–å½“å‰æœåŠ¡çŠ¶æ€æŠ¥å‘Šï¼ŒåŒ…æ‹¬ï¼šæœåŠ¡è¿è¡Œæ—¶é•¿ã€å½“å‰æ‰“å¼€çš„ WebSocket æ•°é‡ã€ç´¯è®¡ WebSocket æ•°é‡ã€WebSocket é”™è¯¯æ•°ã€HTTP é”™è¯¯æ•°ã€‚ä½¿ç”¨é”ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ |
| `(db *dashboard) incrWs()`                 | æ—               | æ—              | WebSocket æ–°è¿æ¥å»ºç«‹æ—¶è°ƒç”¨ï¼Œç´¯è®¡ `totalWs` å¢åŠ  1ã€‚çº¿ç¨‹å®‰å…¨ã€‚ |
| `(db *dashboard) onWsErr(err error)`       | `err error`     | æ—              | WebSocket å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨ï¼Œç´¯è®¡ `wsErrs` å¢åŠ  1ã€‚çº¿ç¨‹å®‰å…¨ã€‚   |
| `(db *dashboard) onHttpErr(err error)`     | `err error`     | æ—              | HTTP è¯·æ±‚å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨ï¼Œç´¯è®¡ `httpErrs` å¢åŠ  1ã€‚çº¿ç¨‹å®‰å…¨ã€‚  |

## roomTable.go

| æ–¹æ³•å                                                       | å‚æ•°                                                 | è¿”å›å€¼  | ä½œç”¨è¯´æ˜                                                     |
| ------------------------------------------------------------ | ---------------------------------------------------- | ------- | ------------------------------------------------------------ |
| `(rt *roomTable) room(id string)`                            | `id`ï¼šæˆ¿é—´ ID                                        | `*room` | è·å–æŒ‡å®šæˆ¿é—´ï¼Œå¦‚æœæˆ¿é—´ä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„æˆ¿é—´ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ã€‚ |
| `(rt *roomTable) roomLocked(id string)`                      | `id`ï¼šæˆ¿é—´ ID                                        | `*room` | ä¸ `room` ç±»ä¼¼ï¼Œä½†å‡è®¾è°ƒç”¨æ–¹å·²ç»æŒæœ‰é”ï¼Œä¸å†é‡å¤åŠ é”ã€‚       |
| `(rt *roomTable) remove(rid string, cid string)`             | `rid` æˆ¿é—´ IDï¼Œ`cid` å®¢æˆ·ç«¯ ID                       | æ—       | åˆ é™¤æŒ‡å®šå®¢æˆ·ç«¯ï¼Œå¦‚æœæˆ¿é—´ä¸ºç©ºåˆ™åˆ é™¤æˆ¿é—´ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ã€‚         |
| `(rt *roomTable) removeLocked(rid string, cid string)`       | åŒä¸Š                                                 | æ—       | ä¸ `remove` ç±»ä¼¼ï¼Œä½†å‡è®¾é”å·²æŒæœ‰ã€‚                           |
| `(rt *roomTable) send(rid string, srcID string, msg string)` | `rid` æˆ¿é—´ IDï¼Œ`srcID` å‘é€è€… IDï¼Œ`msg` æ¶ˆæ¯å†…å®¹     | `error` | è½¬å‘æ¶ˆæ¯åˆ°æŒ‡å®šæˆ¿é—´ï¼Œå¦‚æœæˆ¿é—´ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œè°ƒç”¨æˆ¿é—´çš„ `send` æ–¹æ³•ã€‚ |
| `(rt *roomTable) register(rid string, cid string, rwc io.ReadWriteCloser)` | `rid` æˆ¿é—´ IDï¼Œ`cid` å®¢æˆ·ç«¯ IDï¼Œ`rwc` WebSocket è¿æ¥ | `error` | å°†å®¢æˆ·ç«¯æ³¨å†Œåˆ°æŒ‡å®šæˆ¿é—´ï¼Œå¦‚æœæˆ¿é—´ä¸å­˜åœ¨åˆ™åˆ›å»ºã€‚               |
| `(rt *roomTable) deregister(rid string, cid string)`         | `rid` æˆ¿é—´ IDï¼Œ`cid` å®¢æˆ·ç«¯ ID                       | æ—       | æ³¨é”€å®¢æˆ·ç«¯çš„ WebSocket æ³¨å†Œï¼Œä½†ä¿ç•™å®¢æˆ·ç«¯å¯¹è±¡ï¼Œç­‰å¾…è¶…æ—¶åè‡ªåŠ¨ç§»é™¤ï¼Œä»¥ä¾¿ç”¨æˆ·å¯æ— ç¼é‡è¿ã€‚ |
| `(rt *roomTable) removeIfUnregistered(rid string, c *client)` | `rid` æˆ¿é—´ IDï¼Œå®¢æˆ·ç«¯å¯¹è±¡                            | æ—       | è¶…æ—¶æ£€æŸ¥å‡½æ•°ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨è¶…æ—¶æ—¶é—´å†…æœªæ³¨å†Œï¼Œåˆ™ç§»é™¤è¯¥å®¢æˆ·ç«¯ã€‚ |
| `(rt *roomTable) wsCount()`                                  | æ—                                                    | `int`   | è¿”å›å½“å‰æ‰€æœ‰æˆ¿é—´ä¸­æ´»è·ƒ WebSocket è¿æ¥æ€»æ•°ã€‚                  |

## room.go

| æ–¹æ³•å                                                       | å‚æ•°                          | è¿”å›å€¼           | ä½œç”¨è¯´æ˜                                                     |
| ------------------------------------------------------------ | ----------------------------- | ---------------- | ------------------------------------------------------------ |
| `(rm *room) client(clientID string)`                         | å®¢æˆ·ç«¯ ID                     | `*client, error` | è·å–æˆ¿é—´å†…æŒ‡å®šå®¢æˆ·ç«¯ï¼Œå¦‚æœä¸å­˜åœ¨ä¸”æˆ¿é—´æœªæ»¡åˆ™åˆ›å»ºæ–°å®¢æˆ·ç«¯ï¼›è®¾ç½®æ³¨å†Œè¶…æ—¶å®šæ—¶å™¨ï¼Œè¶…æ—¶æœªæ³¨å†Œåˆ™ç”±çˆ¶ `roomTable` åˆ é™¤ã€‚ |
| `(rm *room) register(clientID string, rwc io.ReadWriteCloser)` | å®¢æˆ·ç«¯ IDï¼ŒWebSocket è¿æ¥å¯¹è±¡ | `error`          | å°†å®¢æˆ·ç«¯ç»‘å®šåˆ° WebSocket è¿æ¥ï¼›æ³¨å†Œåå¦‚æœæˆ¿é—´æœ‰å…¶ä»–å®¢æˆ·ç«¯ï¼Œåˆ™å‘é€é˜Ÿåˆ—æ¶ˆæ¯ç»™æ–°å®¢æˆ·ç«¯ã€‚ |
| `(rm *room) send(srcClientID string, msg string)`            | å‘é€æ–¹å®¢æˆ·ç«¯ IDï¼Œæ¶ˆæ¯å†…å®¹     | `error`          | å°†æ¶ˆæ¯å‘é€ç»™æˆ¿é—´å†…å¦ä¸€å®¢æˆ·ç«¯ï¼›å¦‚æœå¦ä¸€å®¢æˆ·ç«¯æœªåŠ å…¥ï¼Œåˆ™å°†æ¶ˆæ¯å…¥é˜Ÿç­‰å¾…ã€‚ |
| `(rm *room) remove(clientID string)`                         | å®¢æˆ·ç«¯ ID                     | æ—                | ç§»é™¤æŒ‡å®šå®¢æˆ·ç«¯ï¼Œå…³é—­è¿æ¥ï¼›å‘æˆ¿é—´æœåŠ¡å™¨å‘é€ `BYE` è¯·æ±‚ï¼›ä» `clients` map åˆ é™¤å®¢æˆ·ç«¯ã€‚ |
| `(rm *room) empty()`                                         | æ—                             | `bool`           | åˆ¤æ–­æˆ¿é—´æ˜¯å¦ä¸ºç©ºï¼ˆæ²¡æœ‰å®¢æˆ·ç«¯ï¼‰ã€‚                             |
| `(rm *room) wsCount()`                                       | æ—                             | `int`            | ç»Ÿè®¡æˆ¿é—´å†…å·²æ³¨å†Œçš„ WebSocket å®¢æˆ·ç«¯æ•°é‡ï¼Œç”¨äºå…¨å±€ç»Ÿè®¡ã€‚      |



## client.go

| æ–¹æ³•         | ä½œç”¨                                                  |
| ------------ | ----------------------------------------------------- |
| `newClient`  | åˆ›å»º client                                           |
| `setTimer`   | è®¾ç½®é‡è¿è®¡æ—¶å™¨ï¼ˆä¼šåœæ­¢æ—§ timerï¼‰                      |
| `register`   | æ³¨å†Œ WebSocket è¿æ¥                                   |
| `deregister` | æ¸…ç† WebSocket è¿æ¥                                   |
| `registered` | æ˜¯å¦å·²æ³¨å†Œ WebSocket                                  |
| `enqueue`    | å½“å‰ client å‡ºæ¶ˆæ¯ï¼ˆå‘ç»™åˆ«äººï¼‰ä½†å¯¹æ–¹ä¸åœ¨çº¿ â†’ ç¼“å­˜æ¶ˆæ¯ |
| `sendQueued` | æŠŠé˜Ÿåˆ—æ¶ˆæ¯å‘é€ç»™å¯¹æ–¹ï¼ˆåœ¨å¯¹æ–¹è¿æ¥æ—¶è°ƒç”¨ï¼‰              |
| `send`       | å¯¹å¤–å‘é€æ¶ˆæ¯ï¼ˆå¦‚æœå¯¹æ–¹åœ¨çº¿å°±ç›´æ¥å‘ï¼Œå¦åˆ™ç¼“å­˜ï¼‰        |



## messages.go

| æ–¹æ³•å                                        | å‚æ•°                                                   | ä½œç”¨è¯´æ˜                                                     |
| --------------------------------------------- | ------------------------------------------------------ | ------------------------------------------------------------ |
| **sendServerMsg(w io.Writer, msg string)**    | `w`: WebSocket writerã€`msg`: è¦å‘é€çš„æ¶ˆæ¯å†…å®¹         | æ„é€  `wsServerMsg{Msg: msg}` å¹¶å‘é€ç»™å®¢æˆ·ç«¯ï¼ˆJSON æ ¼å¼ï¼‰     |
| **sendServerErr(w io.Writer, errMsg string)** | `w`: WebSocket writerã€`errMsg`: é”™è¯¯æ¶ˆæ¯              | æ„é€  `wsServerMsg{Error: errMsg}` å¹¶å‘é€ç»™å®¢æˆ·ç«¯ï¼ˆJSON æ ¼å¼ï¼‰ |
| **send(w io.Writer, data interface{})**       | `w`: writerï¼ˆé€šå¸¸æ˜¯ websocket.Connï¼‰`data`: ä»»æ„ç»“æ„ä½“ | å°†ç»“æ„ä½“åºåˆ—åŒ–æˆ JSON å†™å…¥ WebSocketï¼›åº•å±‚é€šç”¨å‘é€å‡½æ•°       |
